# Claude Code Instructions for portbahn-islay

## Version Control Policy - ALWAYS FOLLOW

### Before Starting Any Work
1. Check git status and ensure working directory is clean
2. For significant work (>1 file or breaking changes), create a feature branch:
   ```
   git checkout -b feature/descriptive-name
   ```

### During Work
1. Commit after each logical unit of work (not just at the end)
2. Use descriptive commit messages following conventional commits format:
   ```
   feat: add new schema fields for personality data
   fix: resolve TypeScript error in sanity config
   docs: update migration strategy documentation
   ```

### After Completing Work
1. Show user what will be committed with `git status`
2. Stage relevant files with `git add`
3. Create commit with clear message
4. For feature branches: push with `git push -u origin <branch-name>`
5. Tag major milestones: `git tag -a v1.x.x -m "description"`

### Commit Message Format
```
<type>: <subject>

<body - explain what and why, not how>

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
```

Types: feat, fix, docs, style, refactor, test, chore

### Rollback Strategy
- Always preserve ability to rollback with `git reset --hard <commit>`
- For Sanity data: keep exports in `data/exports/` with timestamps
- Never force push to main branch without explicit permission

### When To Ask Before Committing
- Changes to schema files
- Database migrations or data imports
- Configuration files (package.json, tsconfig, etc)
- Anything that could break production

### Auto-Commit Permission
- Documentation updates
- New component files
- Test files
- Minor bug fixes (with clear description)

## Token Tracking Policy - ALWAYS FOLLOW

### Session Token Management
1. **At start of each session**: Report current token count from system
2. **Every ~25k tokens**: Provide checkpoint summary:
   - Work completed so far
   - Remaining tasks
   - Estimated tokens needed
   - Suggest commit point if approaching limits

3. **At 75% usage (150k/200k)**:
   - Commit all work completed
   - Provide handoff summary for next session
   - List any incomplete tasks

4. **Session Handoff Format**:
   ```markdown
   ## Session Summary (Tokens: X/200k)

   ### Completed:
   - Task 1 with commit hash
   - Task 2 with commit hash

   ### In Progress:
   - Task 3 (50% complete, needs: X, Y, Z)

   ### Next Session Should:
   1. Continue from commit abc123
   2. Focus on remaining subtasks
   3. Estimated tokens needed: ~Xk
   ```

5. **Token-Efficient Practices**:
   - Use Task tool for large file operations (spawns sub-agents)
   - Avoid re-reading large files unnecessarily
   - Commit frequently to preserve work
   - Break large tasks into sessions if needed

### When To Start New Session
- Approaching 150k tokens (75% usage)
- Major task completed and committed
- Natural break point in work (schema done, data ready, etc.)

## Project-Specific Notes
- Sanity dataset: production
- Always create data exports before schema changes
- Keep backup exports in `data/exports/` with ISO timestamps
- Context budget: 200k tokens per session
- Large operations (data generation, migrations): use Task tool for efficiency
